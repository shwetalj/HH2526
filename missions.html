<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Guide - History Hackers #71494</title>
    <link rel="stylesheet" href="shared-styles.css">
    <link rel="stylesheet" href="missions-styles.css">
</head>
<body>
    <div class="bg-animation"></div>
    <!-- Loader -->
    <div class="loader">
        <div class="loader-spinner"></div>
    </div>

    <!-- Animated Background -->
    <div class="bg-animation"></div>
    
    <!-- Navigation -->
    <header id="header">
        <nav>
            <a href="index.html" class="logo">
                <span>üèõÔ∏è</span>
                <span>History Hackers #71494</span>
            </a>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="missions.html" class="nav-link active">Missions</a></li>
                <li><a href="pybricks_tutorial.html" class="nav-link">Tutorial</a></li>
                <li><a href="pybricks_cheatsheet.html" class="nav-link">Cheat Sheet</a></li>
            </ul>
            <button class="mobile-menu-toggle" id="mobileToggle" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </nav>
    </header>

    <div class="main-container">
        <div class="map-container">
            <div class="controls">
                <button class="toggle-grid" onclick="toggleGrid()">Toggle Grid</button>
                <span class="coord-display">X: <span id="xCoord">0</span>% | Y: <span id="yCoord">0</span>%</span>
            </div>
            
            <div class="map-wrapper" id="mapWrapper">
                <picture>
                    <source srcset="images/FLL_Unearthed_SETUP.webp" type="image/webp">
                    <img src="images/FLL_Unearthed_SETUP.png" alt="FLL Unearthed Game Field" class="map-image" id="fieldImage">
                </picture>
                
                <!-- Grid Overlay -->
                <div class="grid-overlay" id="gridOverlay"></div>
                
                <!-- Mission Markers Container -->
                <div class="markers-container" id="markers-container">
                    <!-- Markers will be dynamically generated -->
                </div><!-- End markers-container -->
            </div>
            
            <div class="legend">
                <h3>Mission Markers</h3>
                <div class="legend-item">
                    <span class="legend-marker"></span>
                    Click on any gold marker to view mission hints and strategies
                </div>
            </div>
        </div>
    </div>

    <!-- Mission Information Table -->
    <div class="mission-table-container">
        <h2>Mission Information</h2>
        <table class="mission-table">
            <thead>
                <tr>
                    <th>M#</th>
                    <th>Mission Name</th>
                    <th>Description</th>
                    <th>Points Scoring</th>
                    <th>Video</th>
                </tr>
            </thead>
            <tbody id="mission-table-body">
                <!-- Mission rows will be dynamically generated -->
            </tbody>
        </table>
    </div>

    <!-- Hint Popup -->
    <div class="hint-popup" id="hintPopup">
        <button class="close-btn" onclick="closeHint()">&times;</button>
        <h3 id="hintTitle">Mission Title</h3>
        <p id="hintContent">Mission hint content will appear here.</p>
    </div>

    <!-- Video Modal -->
    <div class="video-modal" id="videoModal">
        <div class="video-modal-content">
            <button class="video-close-btn" onclick="closeVideo()">&times;</button>
            <h3 id="videoTitle">Mission Video</h3>
            <div class="video-container" id="videoContainer">
                <!-- YouTube iframe will be inserted here -->
            </div>
            <!-- Custom End Screen -->
            <div class="custom-end-screen" id="customEndScreen">
                <div class="end-screen-content">
                    <h3 id="endScreenTitle">Mission Complete!</h3>
                    <div class="mission-score" id="endScreenScore">Points Earned</div>
                    <div class="next-options" id="nextOptions">
                        <!-- Buttons will be dynamically added -->
                    </div>
                </div>
            </div>
            <!-- Video Controls -->
            <div class="video-controls">
                <div class="speed-control">
                    <label for="speedSelect">Speed:</label>
                    <select id="speedSelect" name="speedSelect" onchange="changePlaybackSpeed(this.value)">
                        <option value="0.25">0.25x</option>
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected="selected">1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Playlist Controls -->
    <div class="playlist-controls" id="playlistControls">
        <div class="playlist-header">
            <h4>Mission Playlist</h4>
            <button class="playlist-close" id="playlistCloseBtn">&times;</button>
        </div>
        <div class="playlist-items" id="playlistItems">
            <!-- Playlist items will be dynamically added -->
        </div>
        <div class="playlist-actions">
            <button id="playAllBtn">‚ñ∂ Play All</button>
            <button id="shuffleBtn">üîÄ Shuffle</button>
            <button id="clearBtn">üóëÔ∏è Clear</button>
        </div>
    </div>
    
    <!-- Playlist Trigger Button -->
    <button class="playlist-trigger" id="playlistTrigger">üìã Mission Playlist</button>
    </div>

        <script src="mission_data.js"></script>
    <script>
        // --- Globals ---
        let player;
        let currentMissionIndex = -1;
        let playlist = [];
        let playlistMode = false;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            generateMarkers();
            generateTable();
            initializeLogic();
        });

        window.onYouTubeIframeAPIReady = function() {};

        // --- DOM Generation ---
        function generateMarkers() {
            const container = document.getElementById('markers-container');
            if (!container) return;
            const fragment = document.createDocumentFragment();
            missionData.forEach(mission => {
                if (!mission.position || mission.position.x === 0) return;
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.style.setProperty('--x', mission.position.x + '%');
                marker.style.setProperty('--y', mission.position.y + '%');
                marker.dataset.mission = mission.id;
                marker.setAttribute('role', 'button');
                marker.setAttribute('aria-label', `Mission ${mission.id}: ${mission.name}`);
                marker.innerHTML = `
                    <div class="marker-content">
                        <span class="marker-label">${mission.id}</span>
                        <span class="marker-name">${mission.name}</span>
                    </div>
                `;
                fragment.appendChild(marker);
            });
            container.appendChild(fragment);
        }

        function generateTable() {
            const tbody = document.getElementById('mission-table-body');
            if (!tbody) return;
            const fragment = document.createDocumentFragment();
            missionData.forEach(mission => {
                const row = document.createElement('tr');
                const videoButton = mission.video_id ? `<button class="video-link" data-video-id="${mission.video_id}">Watch Video üé¨</button>` : '';
                row.innerHTML = `
                    <td class="mission-number"><a href="#" class="mission-link" data-mission="${mission.id}">M${mission.id}</a></td>
                    <td class="mission-name"><a href="#" class="mission-link" data-mission="${mission.id}">${mission.name}</a></td>
                    <td class="mission-desc">${mission.description}</td>
                    <td class="mission-points">${mission.points}</td>
                    <td class="mission-video">${videoButton}</td>
                `;
                fragment.appendChild(row);
            });
            tbody.appendChild(fragment);
        }
        
        function createGrid() {
            const gridOverlay = document.getElementById('gridOverlay');
            if (!gridOverlay) return;
            const fragment = document.createDocumentFragment();
            for (let i = 0; i <= 100; i += 10) {
                const lineH = document.createElement('div');
                lineH.className = 'grid-line-h';
                lineH.style.top = i + '%';
                fragment.appendChild(lineH);

                const lineV = document.createElement('div');
                lineV.className = 'grid-line-v';
                lineV.style.left = i + '%';
                fragment.appendChild(lineV);
            }
            gridOverlay.appendChild(fragment);
        }

        // --- Event & Core Logic ---
        function initializeLogic() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.head.appendChild(tag);

            createGrid();

            // Event Listeners
            document.querySelector('.toggle-grid')?.addEventListener('click', () => document.getElementById('gridOverlay').classList.toggle('show'));
            document.querySelector('.video-close-btn')?.addEventListener('click', closeVideo);
            document.getElementById('videoModal')?.addEventListener('click', (e) => { if(e.target === e.currentTarget) closeVideo(); });
            document.getElementById('playlistTrigger')?.addEventListener('click', togglePlaylist);
            document.getElementById('playlistCloseBtn')?.addEventListener('click', togglePlaylist);
            document.getElementById('playAllBtn')?.addEventListener('click', playAllMissions);
            document.getElementById('shuffleBtn')?.addEventListener('click', shufflePlaylist);
            document.getElementById('clearBtn')?.addEventListener('click', clearPlaylist);
            
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            document.body.addEventListener('click', (e) => {
                const missionLink = e.target.closest('.mission-link, .marker');
                if (missionLink) {
                    e.preventDefault();
                    const mission = missionData.find(m => m.id === missionLink.dataset.mission);
                    if (mission) showHint(mission, missionLink);
                }

                const videoLink = e.target.closest('.video-link');
                if (videoLink) {
                    const mission = missionData.find(m => m.video_id === videoLink.dataset.videoId);
                    if (mission) playVideo(mission);
                }
            });

            if (!isTouchDevice) {
                document.body.addEventListener('mouseover', (e) => {
                    const target = e.target.closest('.mission-link, .marker');
                    if (target) {
                        const mission = missionData.find(m => m.id === target.dataset.mission);
                        if (mission) showHint(mission, target);
                    }
                });
                document.getElementById('hintPopup')?.addEventListener('mouseleave', closeHint);
            }
        }

        // --- Hint Popup --- 
        function showHint(mission, element) {
            const hintPopup = document.getElementById('hintPopup');
            document.getElementById('hintTitle').textContent = `M${mission.id}: ${mission.name}`;
            document.getElementById('hintContent').innerHTML = `<picture><source srcset="${mission.hint_image}.webp" type="image/webp"><img src="${mission.hint_image}.png" alt="${mission.name} Hint Card"></picture>`;
            const rect = element.getBoundingClientRect();
            const popupWidth = hintPopup.offsetWidth;
            let left = rect.right + 10;
            if (left + popupWidth > window.innerWidth) left = rect.left - popupWidth - 10;
            hintPopup.style.left = left + 'px';
            hintPopup.style.top = rect.top + 'px';
            hintPopup.classList.add('active');
        }

        function closeHint() { document.getElementById('hintPopup')?.classList.remove('active'); }

        // --- Video Player ---
        function playVideo(mission) {
            const modal = document.getElementById('videoModal');
            const videoContainer = document.getElementById('videoContainer');
            document.getElementById('videoTitle').textContent = `M${mission.id}: ${mission.name}`;

            if (player && typeof player.destroy === 'function') player.destroy();
            videoContainer.innerHTML = '<div id="youtube-player"></div>';
            modal.classList.add('active');

            currentMissionIndex = playlist.findIndex(p => p.id === mission.id);

            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: mission.video_id,
                playerVars: { autoplay: 1, controls: 1, modestbranding: 1, rel: 0, start: mission.start_time, end: mission.end_time, playsinline: 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) showEndScreen();
        }

        function closeVideo() {
            const modal = document.getElementById('videoModal');
            if (player && typeof player.stopVideo === 'function') player.stopVideo();
            modal.classList.remove('active');
            document.getElementById('videoContainer').innerHTML = '';
        }

        // --- End Screen ---
        function showEndScreen() {
            const endScreen = document.getElementById('customEndScreen');
            const mission = playlist[currentMissionIndex];
            if (!mission) { closeVideo(); return; }

            document.getElementById('endScreenTitle').textContent = `M${mission.id}: ${mission.name} Complete!`;
            document.getElementById('endScreenScore').textContent = `Maximum Points: ${mission.points.replace(/<br>/g, ' ')}`;
            
            const nextOptions = document.getElementById('nextOptions');
            nextOptions.innerHTML = '';

            const replayBtn = document.createElement('button');
            replayBtn.textContent = 'üîÑ Replay Mission';
            replayBtn.onclick = () => playVideo(mission);
            nextOptions.appendChild(replayBtn);

            if (playlistMode && currentMissionIndex < playlist.length - 1) {
                 const nextBtn = document.createElement('button');
                 const nextMission = playlist[currentMissionIndex + 1];
                 nextBtn.textContent = `‚û°Ô∏è Next: ${nextMission.id}`;
                 nextBtn.onclick = () => playVideo(nextMission);
                 nextOptions.appendChild(nextBtn);
            }
            endScreen.classList.add('active');
        }

        // --- Playlist ---
        function togglePlaylist() {
            const controls = document.getElementById('playlistControls');
            if (!controls.classList.contains('active')) initializePlaylist();
            controls.classList.toggle('active');
        }

        function initializePlaylist() {
            const container = document.getElementById('playlistItems');
            container.innerHTML = '';
            const videoMissions = missionData.filter(m => m.video_id);
            videoMissions.forEach((mission) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.dataset.missionId = mission.id;
                item.innerHTML = `<span class="playlist-item-number">${mission.id}</span><span class="playlist-item-name">${mission.name}</span>`;
                item.onclick = () => {
                    playlist = videoMissions;
                    playlistMode = true;
                    playVideo(mission);
                    togglePlaylist();
                };
                container.appendChild(item);
            });
        }

        function playAllMissions() {
            playlist = missionData.filter(m => m.video_id);
            playlistMode = true;
            if(playlist.length > 0) playVideo(playlist[0]);
            togglePlaylist();
        }

        function shufflePlaylist() {
            playlist = missionData.filter(m => m.video_id).sort(() => Math.random() - 0.5);
            playlistMode = true;
            if(playlist.length > 0) playVideo(playlist[0]);
            togglePlaylist();
        }

        function clearPlaylist() {
            playlist = [];
            playlistMode = false;
            currentMissionIndex = -1;
        }
    </script>
    <script src="shared-scripts.js"></script>
</body>
</html>